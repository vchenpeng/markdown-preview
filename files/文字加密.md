# 点银宝部署

  服务器名称    | 地址          | 端口
  --            | --            | --
  主服务器      | 120.27.193.58 | *
  redis服务器   | 120.27.193.58 | 6379
  数据库        | *连接方式下方*| 3433
  
> ```
> desc: 数据库测试连接
> addr: rm-bp128s120o1k728s1o.sqlserver.rds.aliyuncs.com,3433
> id: dyb_cp
> pwd：Y2hlbnBlbmc=
> ```

1. =="处理程序ExtensionlessUrlHandler-Integrated-4.0在其模块列表中有一个错误模块ManagedPipelineHandler"：==
```
以管理员运行下面的命令注册

c:\windows\microsoft.net\framework64\v4.0.30319\aspnet_regiis.exe -i
```
2. ==更新数据库配置==
```
update w_webconfig
set 
name='点银宝',
dmain='dianyinbao.net',
bind_domain='m.dianyinbao.net',
original='gh_4f052f7387ba',
appid='wx7d9d190542a215d1',
token='d3hkaWFueWluYmFv',
appsecret='0bc2077358b57e763a20286c642e2bb1'
where id=1

update w_account_info
set
token='d3hkaWFueWluYmFv',
appid='wx7d9d190542a215d1',
appsecret='0bc2077358b57e763a20286c642e2bb1',
original='gh_4f052f7387ba',
encodingAESKey='BbFSaSiwm7HOeDb42qsYblGft92iobyuLied3ZH61P0',
mchid='1436565502',
partner_key = 'uy27Msl2984L02484292MjsA2sk2f79W'
--pay_sign_key=''
where id=1
```
3. 在阿里云服务器安全组【仅部署初期测试调试用，后期请关闭】
- [x]  进入阿里云控制台 > 云服务器ECS > 选中需要管理的这台服务器
- [x]  左侧列表中选择【本实例安全组】进入
- [x]  点击右上角【加入安全组】，搜索【开放Web端口】选中确认
4. 配置redis密码

- 临时生效
```
config get requirepass //获取当前密码
config set requirepass "WeetaoTest123"
```
- 永久生效
```
进入redis安装根目录，找到redis.windows.conf文件，Ctrl + F 搜索以下内容：
requirepass

然后修改为
requirepass WeetaoTest123

注意去掉前面的#号
```
- redis运行
```
cd redis根目录
redis-server redis.windows.conf
```
5. 站点发布配置

  商户后台      | 配置值
  --            | --
  服务器        | https://120.27.193.58:8172/msdeploy.axd
  站点名称      | DianYinBao_BackEnd
  用户名        | iZ66ithuzlmnuuZ\deploy
  密码          | ZGlhbnlpbmJhbw==
  目标          | http://m.dianyinbao.net:80/site
  
  手机端        | 配置值
  --            | --
  服务器        | https://120.27.193.58:8172/msdeploy.axd
  站点名称      | DianYinBao_FontEnd
  用户名        | iZ66ithuzlmnuuZ\deploy
  密码          | ZGlhbnlpbmJhbw==
  目标          | http://m.dianyinbao.net:80/
  
6. 协购点银宝公众号配置
 
  配置名称        | 配置值
  --              | --
  AppID           | wx7d9d190542a215d1
  AppSecret       | 0bc2077358b57e763a20286c642e2bb1
  URL(服务器地址) | http://m.dianyinbao.net/Server/ServerAuth/1
  Token(令牌)     | d3hkaWFueWluYmFv（base64加密wxdianyinbao）
  EncodingAESKey  | ljiuraj5CkPZ5JKzfAfNuTuEpyrekAHlP5ByasnybQM
  消息加解密方式  | 明文模式

7. 协购点银宝公众号消息模板

  模板名称                  | 模板ID
  --                        | --
  预定结果通知              | OPENTM203265592
  预定提醒                  | OPENTM205016454
  动态登录密码通知          | OPENTM206953855
  点餐成功通知              | OPENTM202162340
  点餐机状态提醒            | OPENTM205258310
  成为会员通知              | TM00053
  新订单通知                | OPENTM202617554
  外卖单下单成功提醒        | OPENTM200781461
  订单发货通知              | OPENTM207365764
  订单提交成功通知          | OPENTM201430842
  预订成功通知              | TM00537
  积分变更提醒              | OPENTM200898560
  订单发货通知              | ==所属行业不同==
  预订提醒通知              | TM00532
  云商圈提成比例变更提醒    | OPENTM401523210
  微信支付成功通知          | ==搜索不到==
  用户催单提醒              | OPENTM207024341
  会员卡消费提醒            | ==所属行业不同==
  
  - ==模板必须重新配置，因为不同公众号申请的同一模板，微信分配的template_id不同==
  - 因微信模板所属行业1个月仅可变更一次，以下3个模板暂未录入
```
订单发货通知 [所属行业：其他 - 其他]
{{first.DATA}}
物流单号：{{keyword1.DATA}}
订货单号：{{keyword2.DATA}}
发货时间：{{keyword3.DATA}}
{{remark.DATA}}

微信支付成功通知 [所属行业：餐饮 - 餐饮] 【搜索不到】
{{first.DATA}}
订单号：{{keyword1.DATA}}
消费金额：{{keyword2.DATA}}
消费门店：{{keyword3.DATA}}
消费时间：{{keyword4.DATA}}
{{remark.DATA}}

会员卡消费提醒 [所属行业：其他 - 其他]
{{first.DATA}}
本次消费：{{keyword1.DATA}}
会员卡扣减：{{keyword2.DATA}}
卡上余额：{{keyword3.DATA}}
消费门店：{{keyword4.DATA}}
{{remark.DATA}}
```
  - 模板执行update
```
  --外卖单下单成功提醒
update w_msg_template_send 
set template_id='40c4a7SchrO-B-cf1bacM_NFx2k5Z7G46gDXvPM9bs0' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=1

--新订单通知
update w_msg_template_send 
set template_id='T5tPeo9Kewi10LGi7bEmPboErwARAXzNwhQKMaPJC7Q' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=2

--微信支付成功通知 (未搜索到...)

--点餐成功通知
update w_msg_template_send 
set template_id='u4gH7bEHl5_uXVL1yAr2aKWRgUnupSASXqjG-TjwPvA' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=4

--点餐机状态提醒
update w_msg_template_send 
set template_id='uL7Sk2OQskKrtVolYfwELhDJaZkSqSM_IUAIrTuxs6Q' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=5

--预定提醒
update w_msg_template_send 
set template_id='tdzRuM4_CDoQafb0yfgn_he_MWGo1nwXfFeff7XdFm4' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=6

--预定结果通知
update w_msg_template_send 
set template_id='KpIn0RvJXJIvaGtC5xY6GjaOHmeyWKc_H5Vjm1WupaY' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=7

--订单发货通知
update w_msg_template_send 
set template_id='A3uSr-1ugSqxQxDH8ZEFuMat-csW7iKYxkbjqNkZ_W0' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=8

--动态登录密码通知
update w_msg_template_send 
set template_id='TNpcsdzi46vsb9l2ziT3ZIOr4wI-ztBal306lY5Iwzc' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=9

--用户催单提醒
update w_msg_template_send 
set template_id='HyeShvVwHGkMA8TbERQTOgHG9XdWlX2ZLkUr_oJiHc0' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=10

--积分变更提醒
update w_msg_template_send 
set template_id='W0luu6Onv5BLPSGbAoyH51g4VGuL136CdBtOEv0-VqA' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=11

--云商圈提成比例变更提醒
update w_msg_template_send 
set template_id='X8mNCuM7QYRpzfBZ5Mk4O6xsxo2Ip6qeOdwDP-F7cY8' 
where manager_id=1 and template_id is not null and deleted_at is null and template_code=12
```
  
8. 微信支付配置一览
```
商户号：1436565502【协购点银宝】，1436567502【协购(上海)电子商务有限公司】

授权目录
http://m.dianyinbao.net/pay/
http://m.dianyinbao.net/phone/
http://pay.dianyinbao.net/pay/

支付回调
http://m.dianyinbao.net/pay/CallBackUrl

微信支付API密钥（签名有关）
[待补充]

支付证书（支付的高级接口用到）
[待补充]
```

9. 测试接口配置【陈鹏测试】
```
> 公众号
gh_0580fb6c4b14
wxea94ad4e5a3313eb
0ce1995ad10880c10119f83b46f33a6b
URL(服务器地址)：http://m.dianyinbao.net/Server/ServerAuth/1
Token(令牌)：d3hkaWFueWluYmFv（base64加密wxdianyinbao）
EncodingAESKey：ljiuraj5CkPZ5JKzfAfNuTuEpyrekAHlP5ByasnybQM

> 支付
1404761402
uy27Msl2984L02484292MjsA2sk2f79W
证书文件

> 备注
URL、Token、EncodingAESKey复用了点银宝
```

10. 针对于我点餐堂吃

 - 安装URL Rewrite模块（因为堂吃的url地址是前端url，后端无真实访问目录） [点此下载](http://download.microsoft.com/download/4/E/7/4E7ECE9A-DF55-4F90-A354-B497072BDE0A/rewrite_x64_zh-CN.msi) 
 - 服务器端直接安装就好，无需重启站点或服务器

11. 相关api域名配置

api         | domain                                                | desc
---         |---                                                    |--
oauth2      | auth.dianyinbao.net                                   | 授权
storeapi    | storeapi.dianyinbao.net                               | 门店
order       | order.dianyinbao.net                                  | 订单
food        | food.dianyinbao.net                                   | 菜品
pay         | pay.dianyinbao.net                                    | 支付
wechatapi   | wechatapi.dianyinbao.net,m.dianyinbao.net/wechatapi   | 微信
device      | device.dianyinbao.net                                 | 设备
member      | member.dianyinbao.net                                 | 会员
SMS         | *unknow*                                              | 短信

>域名解析配置:
>
>主域名：api.dianyinbao.net  
>子域名：见上方列表  
>
>方式1：  
>主域名A记录指向：120.27.193.58  
>各个子域名CNAME记录指向：api.dianyinbao.net  
>
>方式2：  
>各个域名单独解析  
>
>备注：各有利弊，目前使用的==方式1==，后期根据部署自行选择

12. 部署API
- RedisConfig的配置需要对应的，需要注意
- 站点中的应用程序目录以及开启发布对应的文件目录
- SMS 短信api暂未部署，用我点餐短信接口

13. 网站文件目录结构

> - [x] 根目录
> - - [x] 手机端
> - - [x] 商户后台
> - - [x] 堂吃收银
> - + [ ] WebAPI
> - - - [x] 门店API
> - - - [x] 菜品API
> - - - [x] 订单API
> - - - [x] 支付API
> - - - [x] 设备API
> - - - [x] 会员API
> - - - [x] OAuthAPI
> - - - [x] WeiXinAPI
> - - - [ ] 短信API

14. 备注
+ 部分功能现依赖redis，关闭redis有些部分直接报错
+ 启动redis时务必配置为需要密码，例如：WeetaoTest123
+ 先配置的公众号为【点银宝】暂无微信支付功能，如测试微信支付执行以下测试sql
> ```
> 测试微信支付用
>
> update w_account_info
> set
> token='d3hkaWFueWluYmFv',
> appid='wxea94ad4e5a3313eb',
> appsecret='0ce1995ad10880c10119f83b46f33a6b',
> original='gh_4f052f7387ba',
> encodingAESKey='ljiuraj5CkPZ5JKzfAfNuTuEpyrekAHlP5ByasnybQM',
> mchid='1404761402',
> partner_key = 'uy27Msl2984L02484292MjsA2sk2f79W'
> --pay_sign_key=''
> where id=1
> 
> 注意：执行此sql后会收不到消息模板等...
> ```
15. MIT
> 版本：0.0.1  
> 作者：协购(上海) 电子商务有限公司  
> 时间：2017-5-1


```

```
